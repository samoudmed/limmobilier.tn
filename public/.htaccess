# For a symfony application to work properly, you MUST store this .htaccess in
# the same directory as your front controller, index.php, in a standard symfony
# web application is under the "public" project subdirectory.

# Use the front controller as index file.
DirectoryIndex index.php

# Uncomment the following line if you install assets as symlinks or if you 
# experience problems related to symlinks when compiling LESS/Sass/CoffeScript.
# Options +FollowSymlinks

# Disabling MultiViews prevents unwanted negotiation, e.g. "/index" should not resolve
# to the front controller "/index.php" but be rewritten to "/index.php/index".
<IfModule mod_negotiation.c>
    Options -MultiViews
</IfModule>

<IfModule mod_rewrite.c>
    RewriteEngine On
	
        RewriteCond %{HTTP_HOST} ^www.(.*)$ [NC]
        RewriteRule ^(.*)$ http://%1/$1 [R=301,L]

	RewriteCond %{REQUEST_URI} ^/public/(.*)$
	RewriteRule ^public/(.*)$ /$1 [L,R=301]

    # This RewriteRule is used to dynamically discover the RewriteBase path.
    # See https://httpd.apache.org/docs/current/mod/mod_rewrite.html#rewriterule
    # Here we will compare the stripped per-dir path *relative to the filesystem
    # path where the .htaccess file is read from* with the URI of the request.
    # 
    # If a match is found, the prefix path is stored into an ENV var that is later 
    # used to properly prefix the URI of the front controller index.php.
    # This is what makes it possible to host a Symfony application under a subpath,
    # such as example.com/subpath

    # The convoluted rewrite condition means:
    #   1. Match all current URI in the RewriteRule and backreference it using $0
    #   2. Strip the request uri the per-dir path and use ir as REQUEST_URI.
    #      This is documented in https://bit.ly/3zDm3SI ("What is matched?")
    #   3. Evaluate the RewriteCond, assuming your DocumentRoot is /var/www/html,
    #      this .htaccess is in the /var/www/html/public dir and your request URI
    #      is /public/hello/world:
    #      * strip per-dir prefix: /var/www/html/public/hello/world -> hello/world
    #      * applying pattern '.*' to uri 'hello/world'
    #      * RewriteCond: input='/public/hello/world::hello/world' pattern='^(/.+)/(.*)::\\2$' => matched
    #   4. Execute the RewriteRule:
    #      * The %1 in the RewriteRule flag E=BASE:%1 refers to the first group captured in the RewriteCond ^(/.+)/(.*)
    #      * setting env variable 'BASE' to '/public'

    RewriteCond %{REQUEST_URI} (.*)à(.*)
    RewriteRule . %1a%2 [R=301,L]

    RewriteCond %{REQUEST_URI} (.*)é(.*)
    RewriteRule . %1e%2 [R=301,L]

    RewriteCond %{REQUEST_URI} (.*)è(.*)
    RewriteRule . %1e%2 [R=301,L]
    
    RewriteCond %{REQUEST_URI} (.*)'(.*)
    RewriteRule . %1-%2 [R=301,L]

    RewriteRule ^annonces/gouvernorat/([^/]+)/([0-9]+)$ /gouvernorat/$1 [R=301,L]
    RewriteRule ^annonces/gouvernorat/([^/]+)/([0-9]+)/([0-9]+)$ /gouvernorat/$1 [R=301,L]
    RewriteRule ^liste/annonces/([^/]+)/([0-9]+)$ /delegation/$1/1 [R=301,L]
    RewriteRule ^liste/annonces/([^/]+)/([0-9]+)/([0-9]+)$ /delegation/$1/1 [R=301,L]
    RewriteRule ^liste/annonces/([^/]+)/([^/]+)/([^/]+)/([0-9]+) /$2/$3/delegation/$1 [R=301,L]
    RewriteRule ^10/1/delegation/sidi-hassine$ /delegation/sidi-hassine [R=301,L]
    RewriteRule ^1/1/delegation/Tunis$ /delegation/tunis [R=301,L]
    RewriteRule ^/7/1/delegation/hammamet$ /delegation/hammamet [R=301,L]
    RewriteRule ^([0-9]+)/([0-9]+)/delegation/([^/]+)$ /delegation/$3 [R=301,L]
    
    RewriteRule ^liste/annonces/kelibia/vente/terrain/56$ /vente/terrain/delegation/kelibia [R=301,L]

    RewriteRule ^liste/annonces/sfax-ville/703/1$ /liste/annonces/sfax-ville/1 [R=301,L]
    RewriteRule ^liste/annonces/sfax-ville/540//1$ /liste/annonces/sfax-ville/1 [R=301,L]
    RewriteRule ^liste/annonces/sfax-ville/595//1$ /liste/annonces/sfax-ville/1 [R=301,L]
    RewriteRule ^Vente-Appartement-hammamet-21-1.html$ /liste/annonces/hammamet/vente/appartement/7 [R=301,L]
    RewriteRule ^/annonce/(.*)-296\.html$ /annonce/terrain-a-vendre-296.html [L,R=301]
    RewriteRule ^/annonce/(.*)-249\.html$ /annonce/superbe-duplex-a-vendre-a-cite-riadh-249.html [L,R=301]
    RewriteRule ^/annonce/(.*)-12.html /annonce/a-louer-petit-etage-de-villa-12.html [L,R=301]
    RewriteRule ^/annonces-agence-tps-immobiliere-3043-1.html%20$ /annonces-agence-tps-immobiliere-3043-1.html [R=301,L]

    #Redirect 301 /Vente-Appartement-monastir-14-1.html /liste/annonces/monastir/vente/appartement/13
    Redirect 301 /annonce-A-vendre-un-joli-appartement-%C3%A0-Tantana-272.html /annonce/A-vendre-un-joli-appartement-a-Tantana-272.html
    Redirect 301 /annonce/Lotissement-à-Hammamet-5.html /annonce/Lotissement-a-Hammamet-5.html
    Redirect 301 /annonce/Apprt-S+2-LYON-1-215.html /annonce/apprt-s-2-lyon-1-215.html
    Redirect 301 /annonce/Vente-Terrain-2.html /annonces-type-vente-terrain-1.html
    Redirect 301 /annonces-vente-type-Villa-region-([a-zA-Z0-9-]*)-21-2.html /liste/annonces/ben-arous/vente/villa/133
    Redirect 301 /annonce/(.*)-78.html /annonce/des-appartements-s-2-a-hammamet-nord-78.html
    Redirect 301 /annonce/(.*)-5.html /annonce/lotissement-a-hammamet-5.html
    Redirect 301 /annonce/(.*)-24.html /annonce/un-appartement-s-1-a-sousse-pour-la-location-estivale-24.html
    RewriteRule ^annonces-offre-Vacances-1.html /annonces-type-location-vacances-1.html [R=301,NC,L]


    RewriteRule ^agence/([a-z0-9-]*)-(.*)-(.*)$ /annonces-agence-$1-$2-$3.html [R=301,NC,L]
    # RewriteRule ^annonce/([a-z0-9_-]+)-(.*).html /annonce-$1-$2.html [R=301,NC,L]
    RewriteRule ^annonces-Vente-([0-9_-]+).html /annonces-offre-vente-$1.html [R=301,NC,L]
    RewriteRule ^annonces-Location-([0-9_-]+).html /annonces-offre-location-$1.html [R=301,NC,L]
    RewriteRule ^annonce-Location-([a-z0-9-]*)-([0-9_-]+).html /annonces-type-location-$1-$2.html [R=301,NC,L]
    RewriteRule ^Location-([a-z0-9-]*)-([a-z0-9-]*)-([0-9_-]+)-([0-9_-]+).html /liste-annonces-$2-location-$1-$3-$4.html [R=301,NC,L]
    
    RewriteRule ^annonce-([a-z0-9-]*)-([0-9_-]+).html /annonce/$1-$2.html [R=301,NC,L]
    RewriteRule ^liste-annonces-([a-z0-9-]*)-([a-z0-9-]*)-([a-z0-9-]*).html /liste/annonces/$1/$2/$3/1 [R=301,NC,L]
        
    RewriteCond %{REQUEST_URI}::$0 ^(/.+)/(.*)::\2$
    RewriteRule .* - [E=BASE:%1]
    
    
    # Sets the HTTP_AUTHORIZATION header removed by Apache
    RewriteCond %{HTTP:Authorization} .+
    RewriteRule ^ - [E=HTTP_AUTHORIZATION:%0]

    # Removes the /index.php/ part from a URL, if present
    RewriteCond %{ENV:REDIRECT_STATUS} =""
    RewriteRule ^index\.php(?:/(.*)|$) %{ENV:BASE}/$1 [R=301,L]

    # If the requested filename exists, simply serve it.
    # Otherwise rewrite all other queries to the front controller.
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteRule ^ %{ENV:BASE}/index.php [L]

    RewriteEngine On
    RewriteCond %{QUERY_STRING} .
    RewriteRule ^(.+)\s$ /$1 [L,R=301]

    RedirectMatch 403 ^/.*\.htaccess$
    RedirectMatch 403 ^/.*\.log$
    RedirectMatch 403 ^/.*\.ini$
    RedirectMatch 403 ^/.*config\.php$
    RedirectMatch 403 ^.*/doc/.*$
    RedirectMatch 403 ^.*/lib/.*\.php$
    RedirectMatch 403 ^.*/tmp/.*\.php$
    RedirectMatch 403 ^.*/modules/(?!TinyMCE/responsive_filemanager/filemanager/).*\.php$
    RedirectMatch 403 ^.*/uploads/.*\.php$
    RedirectMatch 403 ^.*/assets/.*\.php$
</IfModule>

<IfModule !mod_rewrite.c>
    <IfModule mod_alias.c>
        # When mod_rewrite is not available, we instruct a temporary redirect 
        # to the front controller explicitly so that the website
        RedirectMatch 307 ^/$ /index.php/
    </IfModule>
</IfModule>
<IfModule mod_expires.c>
  ExpiresActive On

 # Images
  ExpiresByType image/jpeg "access plus 1 year"
  ExpiresByType image/gif "access plus 1 year"
  ExpiresByType image/png "access plus 1 year"
  ExpiresByType image/webp "access plus 1 year"
  ExpiresByType image/svg+xml "access plus 1 year"
  ExpiresByType image/x-icon "access plus 1 year"

  # Video
  ExpiresByType video/webm "access plus 1 year"
  ExpiresByType video/mp4 "access plus 1 year"
  ExpiresByType video/mpeg "access plus 1 year"

  # Fonts
  ExpiresByType font/ttf "access plus 1 year"
  ExpiresByType font/otf "access plus 1 year"
  ExpiresByType font/woff "access plus 1 year"
  ExpiresByType font/woff2 "access plus 1 year"
  ExpiresByType application/font-woff "access plus 1 year"

  # CSS, JavaScript
  ExpiresByType text/css "access plus 1 year"
  ExpiresByType text/javascript "access plus 1 year"
  ExpiresByType application/javascript "access plus 1 year"

  # Others
  ExpiresByType application/pdf "access plus 1 year"
  ExpiresByType image/vnd.microsoft.icon "access plus 1 year"
</IfModule>
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/html text/css application/javascript
</IfModule>
<IfModule mod_headers.c>
  <FilesMatch "\.(jpg|jpeg|png|gif|webp|svg|ico|css|js|woff|woff2|ttf|otf|eot|mp4|webm|pdf)$">
    Header set Cache-Control "public, max-age=31536000, immutable"
  </FilesMatch>
</IfModule>
<IfModule mod_deflate.c>
  AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css application/javascript application/json
</IfModule>

<IfModule mod_brotli.c>
  AddOutputFilterByType BROTLI_COMPRESS text/html text/plain text/xml text/css application/javascript application/json
</IfModule>

