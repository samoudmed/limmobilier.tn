{% extends 'base.html.twig' %}

{% block body %}
<div class="container py-5">
    <h1 class="mb-4 text-center fw-bold" style="font-size:2.2rem;">Dashboard Immobilier</h1>
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="tile-dashboard bg-primary text-white p-4 rounded shadow-sm mb-3">
                <div class="fs-1 mb-2"><i class="fa fa-building"></i></div>
                <div class="fw-bold">Appartements</div>
                <div class="fs-4">{{ stats|filter(s => s.type == 'Appartement')|map(s => s.nb_annonces)|reduce((a, b) => a + b, 0) }}</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="tile-dashboard bg-success text-white p-4 rounded shadow-sm mb-3">
                <div class="fs-1 mb-2"><i class="fa fa-home"></i></div>
                <div class="fw-bold">Villas</div>
                <div class="fs-4">{{ stats|filter(s => s.type == 'Villa')|map(s => s.nb_annonces)|reduce((a, b) => a + b, 0) }}</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="tile-dashboard bg-warning text-dark p-4 rounded shadow-sm mb-3">
                <div class="fs-1 mb-2"><i class="fa fa-tree"></i></div>
                <div class="fw-bold">Terrains</div>
                <div class="fs-4">{{ stats|filter(s => s.type == 'Terrain')|map(s => s.nb_annonces)|reduce((a, b) => a + b, 0) }}</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="tile-dashboard bg-info text-dark p-4 rounded shadow-sm mb-3">
                <div class="fs-1 mb-2"><i class="fa fa-chart-bar"></i></div>
                <div class="fw-bold">Total annonces</div>
                <div class="fs-4">{{ stats|map(s => s.nb_annonces)|reduce((a, b) => a + b, 0) }}</div>
            </div>
        </div>
    </div>
    <div class="bg-white rounded shadow p-4 mb-5">
        <canvas id="chartPrixM2" height="120"></canvas>
    </div>
    <div class="row g-4">
        {% for stat in stats %}
            <div class="col-md-4">
                <div class="card border-0 h-100">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-2">
                            <span class="me-2" style="font-size:2rem;">
                                {% if stat.type == 'Appartement' %}<i class="fa fa-building text-primary"></i>{% endif %}
                                {% if stat.type == 'Villa' %}<i class="fa fa-home text-success"></i>{% endif %}
                                {% if stat.type == 'Terrain' %}<i class="fa fa-tree text-warning"></i>{% endif %}
                            </span>
                            <span class="badge bg-info text-dark">{{ stat.gouvernorat }}</span>
                        </div>
                        <h5 class="card-title mb-1">{{ stat.type }}</h5>
                        <p class="mb-2"><span class="fw-bold">Prix moyen :</span> <span class="text-primary">{{ stat.prix_moyen|number_format(0, '.', ' ') }} TND</span></p>
                        <p class="mb-2"><span class="fw-bold">Prix moyen au m² :</span> <span class="text-success">{{ stat.prix_m2|number_format(0, '.', ' ') }} TND</span></p>
                        <p class="mb-2"><span class="fw-bold">Référence au m² :</span> <span class="text-warning">{{ stat.ref_m2|default('N/A')|number_format(0, '.', ' ') }} TND</span></p>
                        <p class="mb-0"><span class="fw-bold">Annonces analysées :</span> {{ stat.nb_annonces }}</p>
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://use.fontawesome.com/releases/v6.4.0/js/all.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const ctx = document.getElementById('chartPrixM2').getContext('2d');
            const data = {
                labels: [{% for stat in stats %}'{{ stat.gouvernorat }} - {{ stat.type }}',{% endfor %}],
                datasets: [{
                    label: 'Prix moyen au m² (TND)',
                    data: [{% for stat in stats %}{{ stat.prix_m2 }},{% endfor %}],
                    backgroundColor: 'rgba(54, 162, 235, 0.5)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            };
            new Chart(ctx, {
                type: 'bar',
                data: data,
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false },
                        title: {
                            display: true,
                            text: 'Prix moyen au m² par gouvernorat et type de bien',
                            font: { size: 18 }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        });
    </script>
{% endblock %}
